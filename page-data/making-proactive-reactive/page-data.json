{"componentChunkName":"component---src-templates-post-tsx","path":"/making-proactive-reactive","result":{"data":{"markdownRemark":{"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.youtube.com/watch?v=SxdOUGdseq4"},"children":[{"type":"text","value":"Simplifying"}]},{"type":"text","value":" existing solutions and creating new ones are the most important tasks an Engineer is supposed to do in a Company."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A simpler solution is more effective than a complex solution."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It often involves "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Occam%27s_razor"},"children":[{"type":"text","value":"fewer assumptions"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This fact sounds obvious when read."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"But in practice is much harder to detect in real life."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And the experience may go away silently if you don't often reflect on the things you do."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this post, I'll explain a specific situation in which I was able to identify this."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When code is needed, I'll use JS-like pseudocode and sequence diagrams."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Structure of the post:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Introduction: Context"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The problem with the initial state"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Initial cache pattern"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Solution 1: Proactive loading"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Solution 2: Reactive loading"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Current situation"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Conclusions"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"That said, let's jump into it!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Context"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"I'm working on a marketing website, which is visited daily by more than 250k users. The servers receive more than 15M requests per day, according to the CDN stats."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When you have this kind of load, being up and replying fast is super important, and being stable when providing that performance through time and locations also is. This notion is nothing new, as is one of the main goals of "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Site_reliability_engineering"},"children":[{"type":"text","value":"Site Reliability Engineering (SRE)"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For this reason, it often makes sense to have a cache layer between the CMS (especially when it is a third party) and the Web server."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Also, it is worth mentioning that we always have different kinds of alerts in place (Opsgenie from Pingdom, plus Prometheus and Grafana), plus a bunch of metrics to understand the website's performance and load. On top of that, we had the CDN usage stats."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"The problem with the initial state"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So, we had a cache."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"But there was a problem with it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When we cleared it, we had "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"micro-downtimes"}]},{"type":"text","value":" because we deployed a new version of the app or because one editor needed their content to be updated right away."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note: Without the "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Observability"},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"observability"}]}]},{"type":"text","value":" in place, it would be much harder to detect since it would require manual tests, plus random chance, and then spreading this through time to find the pattern of the problem."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Initial cache pattern"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The initial version of the website was more oriented to provide the editorial platform's functionality while also providing a solution for caching."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Because of this, we had an initial implementation, which was ignorant of the micro downtimes problems with the high load."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is how a sequence diagram may look like"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"text","value":"sequenceDiagram\n  actor U as Browser\n  participant A as Server\n  participant R as Redis\n  participant C as CMS\n  U->>+A: request '/' route\n  A->>+R: request content\n  R->>-A: I don't have the content\n  A->>+C: request content\n  C->>-A: here you go\n  A->>-U: here you go\n  A->>+R: put content\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Clients usually call the cache like this"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"cache.set(key, async () => {\n  const value = cms.get()\n  return value;\n});\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"cache.set"}]},{"type":"text","value":" implementation was roughly something like this"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"function set(key, getFunction) {\n  let value = cache.get('key');\n  \n  if (!value) {\n    value = await getFunction();\n    cache.set('key', value); // fire and forget\n  }\n  \n  return value\n}\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This approach was enough for some time, but then some problems started to arise."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Because after a cache clear, we wait for the CMS response, Node.JS waits to reply to current pending requests."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And we had thousands of requests pending."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So they all wait."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"They wait at least "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"600 ms"}]},{"type":"text","value":", because, in the most basic API request, we hit 3 CMS endpoints (with cache, of course). Each one of those takes around "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"200ms"}]},{"type":"text","value":" each.\nSome requests went up to "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"30 seconds"}]},{"type":"text","value":" or even more when something went out of control on the third party."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In addition, at some point, our servers could not accept more requests and started to fail with the status codes "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"503 - Service unavailable"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Socket timeout"}]},{"type":"text","value":", or "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"403 - Bad Gateway"}]},{"type":"text","value":". As a result, the throughput went dramatically low, and you could even check the downtime from a browser."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"But... why?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The CMS call is an API call, which means it goes through HTTP, with encryption on top and pointing to a different infrastructure (CMS provider)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can then guess that calling an API endpoint located in a different infrastructure is slower than calling a Redis database on our own, in the most common scenario."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We checked that in a Newrelic dashboard."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This dashboard has shown us how much time a request took on each function call.\nRedis database read access is often lower than "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"25 ms"}]},{"type":"text","value":" and, in some rare scenarios, up to "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"75 ms"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"At the same time, third parties were around "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"200 ms"}]},{"type":"text","value":" and up to more than "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"10 seconds"}]},{"type":"text","value":" from time to time (it happened every two or three weeks in our particular case)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We had to do something to improve this."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Solution 1: Proactive loading"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So, what can we do about it?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Well, having the content in the cache in the first place sounded like an option to us."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So, what if we periodically simulate our users and put everything in cache?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This solution looks something like this"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"text","value":"sequenceDiagram\n  actor J as Cronjob\n  actor U as Browser\n  participant A as Server\n  participant R as Redis\n  participant C as CMS\n  J->>+A: request all routes\n  A->>+C: request content\n  C->>-A: here you go\n  A->>-J: ok, loaded\n  U->>+A: request '/' route\n  A->>+R: request content\n  R->>-A: here you go\n  A->>-U: here you go\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We saw some light there, and we started to move in this direction."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We called it Proactive load."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The idea was to trigger a command via a Cron Job each hour or so, in which we'll load the most popular content, if not all, in the cache."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Because we pull the data from a CMS, it is very similar to how Static Site Generation (SSG) works. For example, I used Gatsby, a web framework on my blog, and a few other projects."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It is just that instead of generating HTML on files, we'll load a bunch of objects in the cache."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When I started programming this, I had to add many new interface methods here and there to manipulate the cache keys and generate all the combinations of the data, which implied lots of new methods and data sources."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It didn't feel very well, to be honest. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"The solution started to smell too complex"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the meantime, a few other things happened."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We use Next.js for the website, and because of that, I was following some releases there. I saw that they released a new feature on the framework, supported by their CDN, called Staled While Revalidate. A pattern that I knew from theory but not so much in practice. They advertised it to be even better than SSG. I didn't believe them (Or understand them?). For me, Gatsby was the new fancy tool in town, and SSG was the new thing better than traditional SSR and the old PHP approach suggested by Next.js."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Also, I was reading parts of the book "},{"type":"element","tagName":"a","properties":{"href":"https://www.reactivedesignpatterns.com/"},"children":[{"type":"text","value":"\"Reactive design patterns\""}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this book, I learned a few things about how reactive systems are often superior because they tend to be more efficient."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now with this in mind, let's think back about the notion of \""},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"nasty smell to complexity"}]},{"type":"text","value":"\".\nIt seems to be related to recent learnings."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To summarize, with this approach, we'll be running a job each hour and loading some content in the cache that maybe never is going to be consumed. So it won't solve the initial issue in the worst scenario unless we always generate "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"everything"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then I remembered the whole thing of \"Stale While Revalidate\" and decided to take a look at it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Solution 2: Reactive loading"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Staled While Revalidate solution looks something like this"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"text","value":"sequenceDiagram\n  actor U as Browser\n  participant A as Server\n  participant R as Redis\n  participant C as CMS\n  U->>+A: request '/' route\n  A->>+R: request content from layer 1\n  R->>-A: I don't have the content\n  A->>+R: request content from layer 2\n  R->>-A: here you go\n  A->>+C: request content if not found\n  C->>-A: hrere you go\n  A->>U: here you go\n  A->>+A: Revalidate\n  A->>+C: request content\n  C->>-A: here you go\n  A->>R: set content on both layers\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There are many changes here."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"First and foremost, it adds a new cache layer with higher TTL (much higher)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The second layer reduces the probability of the need to go to the CMS while making the users wait and causing the "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"micro-downtimes"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It looks like it has the same problem, but probability makes the need to go to the CMS so tiny that it is not a problem anymore."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now, to implement this is super easy. First, we change the cache algorithm, and that's "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"almost it"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There is no need for simulated requests because it uses the actual user event, making it reactive instead of proactive."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now there is a downside: requests that take the content from layer 2 are technically getting old content. But at least they are getting content instead of erroring. And the content is not very old neither (only as old as the last request that triggered the Revalidation function)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"I said "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"almost"}]},{"type":"text","value":" above because we had a CDN in front of our server. And because the CDN is in charge of caching, when returning a "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"staled"}]},{"type":"text","value":" response, you need to tell them to cache the response only for a few seconds (more or less the delay of the request to the CMS) instead of the regular expiration, which may be 6 hours for example. Otherwise, the CDN would continue replying with the staled content for those 6 hours."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Current situation"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The current situation is that we don't have any more "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"micro-downtimes"}]},{"type":"text","value":" when clearing the cache."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"No more "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"micro-downtimes"}]},{"type":"text","value":" is great because when the system is unstable, it causes performance and business implications and brings fear to developers who are afraid to deploy new changes, which is not good."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we are dealing with other kinds of issues I'll share in the future."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Conclusions"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So, how is SWR simpler than SSG?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"First of all, the implementation is more straightforward. It involves fewer new pieces, while it reuses most of the current existing pieces."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Also, it uses the original user event to work, instead of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"assuming"}]},{"type":"text","value":" that an "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"automated user"}]},{"type":"text","value":" with a clunky visit pattern (CRON + script) could generate something useful."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In this particular case, for me, the complex implementation was the first sign."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"My favorite takeaways are:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Try to make complex more straightforward choosing solutions with fewer assumptions"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"In reactive systems, it is essential to distinguish between original events and synthetic ones"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Keep it up with reading and learning; it helps you solve problems"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Have observability in place, get to know your app at runtime"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Special thanks to Dan, Dimi, and Vlad for their collaboration during this process."}]}],"data":{"quirksMode":false}},"timeToRead":8,"frontmatter":{"date":"November 07, 2021","url":"/making-proactive-reactive","title":"Making proactive reactive","author":"nico","draft":null,"categories":["Experiencias","Integration","Tecnicos"],"tags":["proactive reactive staled while revalidate cache"],"type":null,"version":null}}},"pageContext":{}},"staticQueryHashes":["3649515864"]}
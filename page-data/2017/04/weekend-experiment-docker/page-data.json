{"componentChunkName":"component---src-templates-post-tsx","path":"/2017/04/weekend-experiment-docker","webpackCompilationHash":"e22ffd6bcc87f8bf1604","result":{"data":{"markdownRemark":{"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Let's build a small node.js single page application (SPA) using the multi stage builds feature from docker to optimize the image size"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Introduction"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With multi stage builds (a feature announced in the docker con last week) we can create a tiny image that get's pulled and pushed faster to the docker repository."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A Single Page Applications (SPA's) is a convenient use case to test the power of multi stage build easily in the node.js world."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's start with this."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"First step: install docker 17.05-ce"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Easy, go to "},{"type":"element","tagName":"a","properties":{"href":"https://www.docker.com/community-edition#/download"},"children":[{"type":"text","value":"https://www.docker.com/community-edition#/download"}]},{"type":"text","value":"\nChoose your platform AND, because we need multi stage builds and its still on the "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"edge channel"}]},{"type":"text","value":" we need to choose that instead of the stable channel. Download, install."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Second step: Building a SPA"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A single page application is just a static web page that can be served through any traditional web server."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For this example, let's pick a boilerplate SPA like create-react-app."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"npm install -g create-react-app\n\ncreate-react-app my-app\ncd my-app/\nnpm start # if you want to test it and check the browser for it\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Third step: create a Dockerfile"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All right now the important thing, let's take a look at a candidate Dockerfile"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-docker"]},"children":[{"type":"text","value":"# buildtime\nFROM node AS nodebase\nLABEL maintainer \"nicosommi@gmail.com\"\n\nADD . /usr/src/app\nWORKDIR /usr/src/app\nRUN npm i && npm run build\n\n# runtime\nFROM nginx:alpine\nCOPY --from=nodebase /usr/src/app/build /usr/share/nginx/html\n"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So let's see."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We start with a node:latest image, no problem with the image size because now we have multi stage builds."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The LABEL maintainer, that's recent too, no more MAINTAINER special instruction, now it's a label."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We add the current directory to the appropiate location and set the working directory to it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Install, build... and that's all that we need to generate our artifacts in our build folder."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So after that, we take for the runtime the small nginx:alpine image and we just copy the build folder to the right place."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Done!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Fourth step: build and run!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So now, let's build the image\n"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker build -t my-app ."}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And now let's look it's size\n"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker images"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All right! less than 16 MB! With the whole thing, linux, nginx and our app!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"That's great. Just the node_modules folder size after installation is around 130 MB... so this is a BIG win."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's try it"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"docker run -d --rm -p 8000:80 --name my-app my-app"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Open chrome in localhost:8000 and enjoy."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Conclusion"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Multi stage builds are great, it let's you easily build whatever you want and then create a thin self-sufficient pack with exactly what you need to let the user run your application."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"By making this clear distinction between different stages, docker let's you think in a more organized way about the Dockerfile."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With multi stage builds the LAST stage is the one that is used on your final image. Don't forget that. "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"For example, the ONBUILD instruction on a previous stage wont have any effect"}]},{"type":"text","value":" because it will be overwritten with the last stage of the Dockerfile."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As a side note, it is important to say that this may be a trigger to massively use webpack or some kind of bundler for standalone node.js applications. The node_modules folder get's really big very quickly."}]}],"data":{"quirksMode":false}},"timeToRead":2,"frontmatter":{"date":"April 29, 2017","url":"/2017/04/weekend-experiment-docker","title":"Weekend experiment: a node.js SPA with multi stage builds from docker","author":"nico","categories":null,"tags":null,"type":null,"version":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}
<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 3.11.1"/><title data-react-helmet="true">nicosommi</title><link data-react-helmet="true" rel="stylesheet" type="text/css" href="/vendor/fontello/css/fontello.css"/><meta data-react-helmet="true" name="description" content="nicosommi blog"/><meta data-react-helmet="true" name="keywords" content="blog, engineer, developer, javascript, typescript, golang, kubernetes, docker"/><link rel="icon" href="/favicon-32x32.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossOrigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=9aaa16fa2b5f381bbeaa8ec4a1f02f8c"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-44929876-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-44929876-1', 'auto', {});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-e69922dbaa51cbcaf5fc.js"/><link as="script" rel="preload" href="/framework-8d714a4faf31edeed8fb.js"/><link as="script" rel="preload" href="/app-087b2df36aeb0aa58a92.js"/><link as="script" rel="preload" href="/eb1842f2-9376612a55b061cfa558.js"/><link as="script" rel="preload" href="/b5433cdc981f0c288c339c2910d8833f05167fcf-9888df17730814792764.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-a47fafdafd062e79bc8d.js"/><link as="fetch" rel="preload" href="/page-data/making-proactive-reactive/page-data.json" crossOrigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossOrigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossOrigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css-global eoqabc">@font-face{font-family:"Open Sans Extra Bold";src:url(/fonts/open-sans/OpenSans-ExtraBold.ttf);}@font-face{font-family:"Cooper Hewitt";src:url(/fonts/cooper-hewitt/CooperHewitt-Light.otf);}@font-face{font-family:"PT Sans";src:url(/fonts/pt-sans/PTN57F.ttf);}</style><style data-emotion="css-global lxidpn animation-4kt7bh">code{font-family:Menlo,Monaco,"Courier New",monospace;background-color:192,98,192;}html,p{line-height:1.8em;}body{font-family:"PT Sans",Georgia,serif;margin:2%;font-size:14pt;color:white;background:black;-webkit-animation:animation-4kt7bh 1s ease 1;animation:animation-4kt7bh 1s ease 1;}h1{letter-spacing:-1pt;line-height:1.2em;font-family:"Open Sans Extra Bold","Lucida Grande","Lucida Sans","Lucida Sans Regular","Lucida Sans Unicode",Geneva,Verdana,sans-serif;}h2,h3,h4,h5,h6{letter-spacing:1.3pt;font-family:"Cooper Hewitt";text-transform:uppercase;}@media only screen and (max-width: 480px){html{font-size:100%;}}@-webkit-keyframes animation-4kt7bh{from{background:black;}to{background:black;}}@keyframes animation-4kt7bh{from{background:black;}to{background:black;}}</style><div style="margin-bottom:1.45rem"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;transform:skewY(-11deg);overflow:hidden"><style data-emotion="css ov1ktg">.css-ov1ktg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><span class="css-ov1ktg"><style data-emotion="css 1h5x3dy">.css-1h5x3dy{cursor:pointer;}</style><span role="button" title="Switch theme" class="css-1h5x3dy">ðŸŒž</span><style data-emotion="css 6a688p">.css-6a688p{cursor:pointer;opacity:0;x:-15px;}</style><span role="button" title="Save theme" class="css-6a688p"><i class="demo-icon icon-floppy"></i></span></span><style data-emotion="css ga6mmi">.css-ga6mmi{-webkit-text-decoration:none;text-decoration:none;color:white;}.css-ga6mmi:hover{color:rgb(63, 157, 63);padding:0;outline:1px solid rgb(63, 157, 63);outline-offset:2px;}.css-ga6mmi:focus{outline:1px dashed rgb(63, 157, 63);outline-offset:2px;}.css-ga6mmi:visited{color:rgb(63, 157, 63);}</style><a class="css-ga6mmi" href="/"><style data-emotion="css 1u33y1m">.css-1u33y1m{margin:0;margin-left:-100;padding-left:100;width:150%;color:white;background:linear-gradient(to right, rgba(63, 157, 63, 0.3), rgba(63, 157, 63, 1), rgba(100, 20, 100, 1));}</style><h1 class="css-1u33y1m">nicosommi</h1></a><style data-emotion="css mlw8ei">.css-mlw8ei{color:#EEE;margin:0;}</style><h6 class="css-mlw8ei"><span>developer</span></h6><style data-emotion="css 102lqhp">.css-102lqhp{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-ms-flex-pack:space-evenly;-webkit-justify-content:space-evenly;justify-content:space-evenly;}</style><div class="css-102lqhp"><style data-emotion="css ga6mmi">.css-ga6mmi{-webkit-text-decoration:none;text-decoration:none;color:white;}.css-ga6mmi:hover{color:rgb(63, 157, 63);padding:0;outline:1px solid rgb(63, 157, 63);outline-offset:2px;}.css-ga6mmi:focus{outline:1px dashed rgb(63, 157, 63);outline-offset:2px;}.css-ga6mmi:visited{color:rgb(63, 157, 63);}</style><a class="css-ga6mmi" href="/posts"><style data-emotion="css 4kv0r8">.css-4kv0r8 >a{padding-top:5px;}</style><h3 class="css-4kv0r8">posts</h3></a><a class="css-ga6mmi" href="/slides"><h3 class="css-4kv0r8">slides</h3></a><a href="https://www.linkedin.com/in/nicosommi" target="_blank" class="css-ga6mmi"><h3 class="css-4kv0r8"><div class="span3" title="LinkeIn"><i class="demo-icon icon-linkedin-squared"></i></div></h3></a><a href="https://github.com/nicosommi" target="_blank" class="css-ga6mmi"><h3 class="css-4kv0r8"><div class="span3" title="Github"><i class="demo-icon icon-github-circled"></i></div></h3></a></div></div></div><style data-emotion="css 1p4o4ey">.css-1p4o4ey{margin:5% 10%;}@media (max-width: 500px){.css-1p4o4ey{margin:5% 2%;}}</style><div class="css-1p4o4ey"><article><header><h1>Making proactive reactive</h1><div>November 07, 2021</div><div>8<!-- --> min read</div></header><div><p><style data-emotion="css 188kzah">.css-188kzah{background-image:linear-gradient( transparent 0%, transparent calc(40% - 8px), rgba(63, 157, 63, 0.35) calc(40% - 8px), rgba(63, 157, 63, 0.35) 120% );-webkit-transition:background-position 120ms ease-in-out,padding 120ms ease-in-out;transition:background-position 120ms ease-in-out,padding 120ms ease-in-out;-webkit-background-size:100% 200%;background-size:100% 200%;-webkit-background-position:0 0;background-position:0 0;-webkit-text-decoration:none;text-decoration:none;color:white;padding:0;}.css-188kzah:hover{background-image:linear-gradient( transparent 0%, transparent calc(40% - 8px), rgba(63, 157, 63, 1) calc(40% - 8px), rgba(63, 157, 63, 1) 120% );-webkit-background-position:0 90%;background-position:0 90%;}</style><a href="https://www.youtube.com/watch?v=SxdOUGdseq4" target="_blank" class="css-188kzah">Simplifying</a> existing solutions and creating new ones are the most important tasks an Engineer is supposed to do in a Company.</p>
<p>A simpler solution is more effective than a complex solution.</p>
<p>It often involves <a href="https://en.wikipedia.org/wiki/Occam%27s_razor" target="_blank" class="css-188kzah">fewer assumptions</a>.</p>
<p>This fact sounds obvious when read.</p>
<p>But in practice is much harder to detect.</p>
<p>And the experience may go away silently if you don&#x27;t often reflect on the things you do.</p>
<p>In this post, I&#x27;ll explain a specific situation in which I was able to identify this.</p>
<p>When code is needed, I&#x27;ll use JS-like pseudocode and sequence diagrams.</p>
<p>Structure of the post:</p>
<ul>
<li>Introduction: Context</li>
<li>The problem with the initial state</li>
<li>Initial cache pattern</li>
<li>Solution 1: Proactive loading</li>
<li>Solution 2: Reactive loading</li>
<li>Current situation</li>
<li>Conclusions</li>
</ul>
<p>That said, let&#x27;s jump into it!</p>
<h2>Context</h2>
<p>I&#x27;m working on a marketing website, which is visited daily by more than 250k users. The servers receive more than 15M requests per day, according to the CDN stats.</p>
<p>When you have this kind of load, being up and replying fast is super important, and being stable when providing that performance through time and locations also is. This notion is nothing new, as is one of the main goals of <a href="https://en.wikipedia.org/wiki/Site_reliability_engineering" target="_blank" class="css-188kzah">Site Reliability Engineering (SRE)</a>.</p>
<p>For this reason, it often makes sense to have a cache layer between the CMS (especially when it is a third party) and the Web server.</p>
<p>Also, it is worth mentioning that we always have different kinds of alerts in place (Opsgenie from Pingdom, plus Prometheus and Grafana), plus a bunch of metrics to understand the website&#x27;s performance and load. On top of that, we had the CDN usage stats.</p>
<h2>The problem with the initial state</h2>
<p>So, we had a cache.</p>
<p>But there was a problem with it.</p>
<p>When we cleared it, we had <span style="color:#9a86fd" class="token-line"><span class="token plain">micro</span><span class="token operator" style="color:#e09142">-</span><span class="token plain">downtimes</span></span> because we deployed a new version of the app or because one editor needed their content to be updated right away.</p>
<p>Note: Without the <a href="https://en.wikipedia.org/wiki/Observability" target="_blank" class="css-188kzah"><em>observability</em></a> in place, it would be much harder to detect since it would require manual tests, plus random chance, and then spreading this through time to find the pattern of the problem.</p>
<h2>Initial cache pattern</h2>
<p>The initial version of the website was more oriented to provide the editorial platform&#x27;s functionality while also providing a solution for caching.</p>
<p>Because of this, we had an initial implementation, which was ignorant of the micro downtimes problems with the high load.</p>
<p>This is how a sequence diagram may look like</p>
<pre><span id="mermaid-1" class="mermaid">%%{init: {'theme': 'dark'}}%%
sequenceDiagram
  actor U as Browser
  participant A as Server
  participant R as Redis
  participant C as CMS
  U->>+A: request '/' route
  A->>+R: request content
  R->>-A: I don't have the content
  A->>+C: request content
  C->>-A: here you go
  A->>-U: here you go
  A->>+R: put content
</span></pre>
<p>Clients usually call the cache like this</p>
<pre><style data-emotion="css qijqp5">.css-qijqp5{overflow-x:auto;}</style><div class="css-qijqp5"><div style="color:#9a86fd" class="token-line"><span class="token plain">cache</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">set</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">const</span><span class="token plain"> value </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> cms</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">get</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">return</span><span class="token plain"> value</span></div><div style="color:#9a86fd" class="token-line"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain" style="display:inline-block">
</span></div></div></pre>
<p>And the <span style="color:#9a86fd" class="token-line"><span class="token plain">cache</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">set</span></span> implementation was roughly something like this</p>
<pre><div class="css-qijqp5"><div style="color:#9a86fd" class="token-line"><span class="token keyword" style="color:#ffcc99">function</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">set</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token parameter">key</span><span class="token parameter punctuation" style="color:#6c6783">,</span><span class="token parameter"> getFunction</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">let</span><span class="token plain"> value </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">get</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&#x27;key&#x27;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token operator" style="color:#e09142">!</span><span class="token plain">value</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">    value </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">await</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">getFunction</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">    cache</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">set</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&#x27;key&#x27;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783">// fire and forget</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain" style="display:inline-block">
</span></div><div style="color:#9a86fd" class="token-line"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">return</span><span class="token plain"> value</span></div><div style="color:#9a86fd" class="token-line"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span></div><div style="color:#9a86fd" class="token-line"><span class="token plain" style="display:inline-block">
</span></div></div></pre>
<p>This approach was enough for some time, but then some problems started to arise.</p>
<p>Because after a cache clear, we wait for the CMS response, Node.JS waits to reply to current pending requests.</p>
<p>And we had thousands of requests pending.</p>
<p>So they all wait.</p>
<p>They wait at least <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">600</span><span class="token plain"> ms</span></span>, because, in the most basic API request, we hit 3 CMS endpoints (with cache, of course). Each one of those takes around <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">200</span><span class="token plain">ms</span></span> each.
Some requests went up to <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">30</span><span class="token plain"> seconds</span></span> or even more when something went out of control on the third party.</p>
<p>In addition, at some point, our servers could not accept more requests and started to fail with the status codes <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">503</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">-</span><span class="token plain"> Service unavailable</span></span>, <span style="color:#9a86fd" class="token-line"><span class="token plain">Socket timeout</span></span>, or <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">403</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">-</span><span class="token plain"> Bad Gateway</span></span>. As a result, the throughput went dramatically low, and you could even check the downtime from a browser.</p>
<h3>But... why?</h3>
<p>The CMS call is an API call, which means it goes through HTTP, with encryption on top and pointing to a different infrastructure (CMS provider).</p>
<p>We can then guess that calling an API endpoint located in a different infrastructure is slower than calling a Redis database on our own, in the most common scenario.</p>
<p>We checked that in a Newrelic dashboard.</p>
<p>This dashboard has shown us how much time a request took on each function call.
Redis database read access is often lower than <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">25</span><span class="token plain"> ms</span></span> and, in some rare scenarios, up to <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">75</span><span class="token plain"> ms</span></span>.</p>
<p>At the same time, third parties were around <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">200</span><span class="token plain"> ms</span></span> and up to more than <span style="color:#9a86fd" class="token-line"><span class="token number" style="color:#e09142">10</span><span class="token plain"> seconds</span></span> from time to time (it happened every two or three weeks in our particular case).</p>
<p>We had to do something to improve this.</p>
<h2>Solution 1: Proactive loading</h2>
<p>So, what can we do about it?</p>
<p>Well, having the content in the cache in the first place sounded like an option to us.</p>
<p>So, what if we periodically simulate our users and put everything in cache?</p>
<p>This solution looks something like this</p>
<pre><span id="mermaid-2" class="mermaid">%%{init: {'theme': 'dark'}}%%
sequenceDiagram
  actor J as Cronjob
  actor U as Browser
  participant A as Server
  participant R as Redis
  participant C as CMS
  J->>+A: request all routes
  A->>+C: request content
  C->>-A: here you go
  A->>-J: ok, loaded
  U->>+A: request '/' route
  A->>+R: request content
  R->>-A: here you go
  A->>-U: here you go
</span></pre>
<p>We saw some light there, and we started to move in this direction.</p>
<p>We called it Proactive load.</p>
<p>The idea was to trigger a command via a Cron Job each hour or so, in which we&#x27;ll load the most popular content, if not all, in the cache.</p>
<p>Because we pull the data from a CMS, it is very similar to how Static Site Generation (SSG) works. For example, I used Gatsby, a web framework on my blog, and a few other projects.</p>
<p>It is just that instead of generating HTML on files, we&#x27;ll load a bunch of objects in the cache.</p>
<p>When I started programming this, I had to add many new interface methods here and there to manipulate the cache keys and generate all the combinations of the data, which implied lots of new methods and data sources.</p>
<p>It didn&#x27;t feel very well, to be honest. <em>The solution started to smell too complex</em>.</p>
<p>In the meantime, a few other things happened.</p>
<p>We use Next.js for the website, and because of that, I was following some releases there. I saw that they released a new feature on the framework, supported by their CDN, called Staled While Revalidate. A pattern that I knew from theory but not so much in practice. They advertised it to be even better than SSG. I didn&#x27;t believe them (Or understand them?). For me, Gatsby was the new fancy tool in town, and SSG was the new thing better than traditional SSR and the old PHP approach suggested by Next.js.</p>
<p>Also, I was reading parts of the book <a href="https://www.reactivedesignpatterns.com/" target="_blank" class="css-188kzah">&quot;Reactive design patterns&quot;</a>.</p>
<p>In this book, I learned a few things about how reactive systems are often superior because they tend to be more efficient.</p>
<p>Now with this in mind, let&#x27;s think back about the notion of &quot;<em>nasty smell to complexity</em>&quot;.
It seems to be related to recent learnings.</p>
<p>To summarize, with this approach, we&#x27;ll be running a job each hour and loading some content in the cache that maybe never is going to be consumed. So it won&#x27;t solve the initial issue in the worst scenario unless we always generate <em>everything</em>.</p>
<p>Then I remembered the whole thing of &quot;Stale While Revalidate&quot; and decided to take a look at it.</p>
<h2>Solution 2: Reactive loading</h2>
<p>Our implementation for Staled While Revalidate solution looks something like this</p>
<pre><span id="mermaid-3" class="mermaid">%%{init: {'theme': 'dark'}}%%
sequenceDiagram
  actor U as Browser
  participant A as Server
  participant R as Redis
  participant C as CMS
  U->>+A: request '/' route
  A->>+R: request content from layer 1
  R->>-A: I don't have the content
  A->>+R: request content from layer 2
  R->>-A: here you go
  A->>+C: request content if not found
  C->>-A: hrere you go
  A->>U: here you go
  A->>+A: Revalidate
  A->>+C: request content
  C->>-A: here you go
  A->>R: set content on both layers
</span></pre>
<p>There are many changes here.</p>
<p>First and foremost, it adds a new cache layer with higher TTL (much higher).</p>
<p>The second layer reduces the probability of the need to go to the CMS while making the users wait and causing the <span style="color:#9a86fd" class="token-line"><span class="token plain">micro</span><span class="token operator" style="color:#e09142">-</span><span class="token plain">downtimes</span></span>.</p>
<p>It looks like it has the same problem, but probability makes the need to go to the CMS so tiny that it is not a problem anymore.</p>
<p>Now, to implement this is super easy. First, we change the cache algorithm, and that&#x27;s <em>almost it</em>.</p>
<p>There is no need for simulated requests because it uses the actual user event, making it reactive instead of proactive.</p>
<p>Now there is a downside: requests that take the content from layer 2 are technically getting old content. But at least they are getting content instead of erroring. And the content is not very old neither (only as old as the last request that triggered the Revalidation function).</p>
<p>I said <em>almost</em> above because we had a CDN in front of our server. And because the CDN is in charge of caching, when returning a <em>staled</em> response, you need to tell them and/or the browser to cache the response only for a few seconds (more or less the delay of the request to the CMS) instead of the regular expiration, which may be 6 hours for example. Otherwise, the CDN would continue replying with the staled content for those 6 hours. For this, the cache-control header is used.</p>
<h2>Current situation</h2>
<p>The current situation is that we don&#x27;t have any more <span style="color:#9a86fd" class="token-line"><span class="token plain">micro</span><span class="token operator" style="color:#e09142">-</span><span class="token plain">downtimes</span></span> when clearing the cache.</p>
<p>No more <span style="color:#9a86fd" class="token-line"><span class="token plain">micro</span><span class="token operator" style="color:#e09142">-</span><span class="token plain">downtimes</span></span> is great because when the system is unstable, it causes performance and business implications and brings fear to developers who are afraid to deploy new changes or clear the cache, which is not good.</p>
<p>Now we are dealing with other kinds of issues I&#x27;ll share in the future.</p>
<h2>Conclusions</h2>
<p>So, how is the reactive approach simpler than the proactive?</p>
<p>First of all, the implementation is more straightforward. It involves fewer new pieces, while it reuses most of the current existing pieces.</p>
<p>Also, it uses the original user event to work, instead of <em>assuming</em> that an <em>automated user</em> with a clunky visit pattern (CRON + script) could generate something useful.</p>
<p>In this particular case, for me, the complex implementation was the first sign.</p>
<p>My favorite takeaways are:</p>
<ul>
<li>Sometimes, subtracting things from Solutions makes them better<br/>
In this case, one implicit assumption was to assume we will do a good job by simulating the user requests</li>
<li>In reactive systems, it is essential to distinguish between original events and synthetic ones<br/>
Synthetic events could require a lot of work to get right, while original events occur externally, which doesn&#x27;t require ANY effort</li>
<li>Keep it up with reading and learning; it helps you solve problems</li>
<li>Have observability in place, get to know your app at runtime
Logs, metrics, dashboard</li>
</ul>
<p>Special thanks to Dan, Dimi, and Vlad for their collaboration during this process.</p></div><footer><div>nico</div><div>v<!-- -->1.0.1</div></footer></article></div><style data-emotion="css bue21p">.css-bue21p{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;font-size:0.75em;line-height:2em;}</style><div class="css-bue21p"><span>Copyright by nicosommiÂ </span><span aria-label="nerd face" role="img" class="css-0">ðŸ¤“</span></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/making-proactive-reactive";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-2d0129554497884c3ab3.js"],"app":["/app-087b2df36aeb0aa58a92.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-48f442ae594c3544ac16.js"],"component---src-pages-404-js":["/component---src-pages-404-js-49387c410a05572f6cf5.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-e348f6436dbbcaf2300a.js"],"component---src-pages-posts-tsx":["/component---src-pages-posts-tsx-84019e6ec2ce46c2fe09.js"],"component---src-pages-slides-tsx":["/component---src-pages-slides-tsx-1793562fb558283dca1f.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-a47fafdafd062e79bc8d.js"],"component---src-templates-slide-tsx":["/component---src-templates-slide-tsx-901cade4c845d4574274.js"]};/*]]>*/</script><script src="/polyfill-2d0129554497884c3ab3.js" nomodule=""></script><script src="/component---src-templates-post-tsx-a47fafdafd062e79bc8d.js" async=""></script><script src="/b5433cdc981f0c288c339c2910d8833f05167fcf-9888df17730814792764.js" async=""></script><script src="/eb1842f2-9376612a55b061cfa558.js" async=""></script><script src="/app-087b2df36aeb0aa58a92.js" async=""></script><script src="/framework-8d714a4faf31edeed8fb.js" async=""></script><script src="/webpack-runtime-e69922dbaa51cbcaf5fc.js" async=""></script></body></html>
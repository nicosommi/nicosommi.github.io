<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" prefix="og: http://ogp.me/ns#" xmlns:og="http://ogp.me/ns#"><!--<![endif]-->

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="author" content="">
  
	
        <meta property="og:site_name" content="nicosommi">
        <meta property="og:title" content="nicosommi">
        <meta property="og:url" content="http://nicosommi.github.com/slide/docker.secrets/">
        <meta property="og:description" content="a developer&#39;s blog">
    
        <meta property="og:type" content="article" />
        <meta property="og:article:author" content="" />
        <meta property="og:article:published_time" content="2017-03-29T15:38:10-03:00" />
    
        <meta name="generator" content="Hugo 0.16" />
    <title>docker secrets &middot; nicosommi</title>
    <link rel="canonical" href="http://nicosommi.github.com/" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="">
    <link rel="stylesheet" type="text/css" href="http://nicosommi.github.com/css/main.css"/>
    <link rel="stylesheet" type="text/css" href="http://nicosommi.github.com/css/menu.css"/>
    <link rel="stylesheet" type="text/css" href="http://nicosommi.github.com/css/slide.css"/>
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300|Montserrat:700" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"></script>
</head>

<body>
<!--[if lt IE 7]><p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chrome/‎">install Google Chrome</a> to experience this site.</p><![endif]-->

<head><link href="/static/css/main.94c28820.css" rel="stylesheet"></head><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div><script type="text/javascript" src="/static/js/main.32c259e6.js"></script>

<div role="main">
  
  <div class="content">
    <textarea id="source">
      &lt;!-- class: middle --&gt;
&lt;!-- layout: true --&gt;

---
&lt;img src=&#34;/assets/2017-03-25-13-39-09.png&#34; width=&#34;400px&#34;&gt;&lt;/img&gt;

# Docker secrets
## Por nicosommi

---
name: agenda
## Agenda
1. Agenda e introducción
2. Como surgen?
3. ¿Qué son los secrets?
4. ¿Para que sirven?
5. Anotaciones de seguridad
6. Detalles de utilización
7. Preparando nuestras imágenes
8. Creando un secreto sencillo
9. Utilizando secrets con YML&#39;s de docker compose
10. Usando https con secrets
11. Resumen de comandos
12. Q &amp; A
13. Fin

---
## ¿Como surgen?
Porque la comunidad toma decisiones heterogeneas y peligrosas:
- Usar variables de entorno (12 factor app)
- Variables de entorno en build
- Manual build (commit)
- Custom hacks (curl a webserver)
... Se necesitan do&#39;s and don&#39;ts

???
- accesibles por cualquier proceso, guardada en capas intermedias, compartidas para otros contenedores linkeados
- hasta se decidio no encriptarlas solo para que la gente no las use para secretos
---
## ¿Qué son los secrets?
Para docker es un BLOB de datos manejado de manera centralizada.
- Compartido para los servicios del swarm que lo necesitan, solo mientras estos ejecutan
- Solo para swarm... por ahora
- Hasta 500KB (no TAN large)
- Por ahora solo para runtime
&lt;center&gt;
  &lt;img src=&#34;/slide/assets/2017-03-22-21-47-13.png&#34; width=&#34;800px&#34;&gt;&lt;/img&gt;
&lt;/center&gt;

???
Binary Large OBjects
Secure Sockets Layer (ahora Transport Layer Security)
SwarmKit es una libreria que se encarga del node management
Hay un issue en curso para build time secrets
---
## ¿Para que sirven?
- Para guardar certificados SSL, SSH Keys, Username y Passwords, nombres de bases de datos... y cualquier dato sensible que debe estar en runtime, pero no en la imagen ni en el control de versiones
- Funciona como capa de abstraccion entre las credenciales y los contenedores

???
- En los distintos ambientes puedo tener credenciales con el mismo nombre pero distinto contenido y entonces el contenedor es exactamente igual mas alla de que los secrets cambien de contenido

---
## Anotaciones de seguridad
- Viajan a los managers del swarm por TLS
- Se almacenan en el Raft log, con todo lo que ello nos garantiza (que está encriptado y es replicado a través de los managers, garantizando la misma HA que el resto de la informacion del swarm)
- Cuando se detiene un container, se hace unmount y se flushea la memoria
- Si se pierde conexión con el swarm, se tiene acceso al secret, pero no puede recibir ninguna instrucción hasta que se vuelva a conectar al swarm  
http://thesecretlivesofdata.com/raft/

???
* Esta encriptado desde la 1.13
* El rotado de secrets es basicamente actualizar el servicio con el secret viejo y el nuevo, proceder a cambiarlo en el servicio, luego borrarlo del servicio y finalmente borrarlo del swarm
* El &#34;Raft log&#34; se refiere al consensus algorithm que utiliza swarmkit *entre managers* para coordinar nodos y no depender de un solo punto de falla para tomar decisiones. Raft fue diseñado para ser simple de entender y que más sistemas utilizen un buen algoritmo de consenso para ser más tolerantes a fallas. Consiste en un simple sistema de eleccion de lider y de propagacion de estado. Define followers, candidatos y líderes.
* Cuando no hay lideres, se inician las rondas de timeout random para que un nodo se vuelva candidato, vote por si mismo y reciba votos de los otros nodos. Las rondas terminan cuando un líder es elegido. Después hay un heartbeat timeout y cuando se pierde el lider se hace la re eleccion.
http://thesecretlivesofdata.com/raft/
Tienen un log y una maquina de estados.
Si una parte del cluster se cae, el que tiene mayoria igual puede impactar, los que no tienen mayoria dejan pendiente, y cuando reciben el mensaje de quien tenia mayoria, hacen rollback y acceden al cambio del lider que tiene mayoria, también relegando su liderazgo.

---
## Detalles de utilización
- Se montan en /run/secrets/name
- Solo tiene acceso si es un manager o si tiene permisos específicos
- Se pueden ver, listar los secrets, pero no se puede borrar uno que está siendo utilizado, para ello se debe rotar el secret
- Se recomienda poner en el nombre una fecha o numero de version, para hacer más sencillo el control

???
- --secret source=mysql_password,target=wp_db_password,mode=0400

---
## Preparando nuestras imágenes
- Para hacer nuestras imagenes secrets-friendly debemos brindar, tal como lo hizo wordpress, una alternativa de archivos a la environment variable que clasicamente se utiliza (MYSQL_PASSWORD_FILE además de MYSQL_PASSWORD)

---
## Creando un secreto sencillo
```shell
$ docker swarm init --advertise-addr eth0 # solo para probar local
$ openssl rand -base64 20 | docker secret create mi_secreto -
$ docker service create --name mi_servicio --secret mi_secreto nginx
$ docker exec $(docker ps --filter name=mi_servicio -q) ls /run/secrets
$ docker exec $(docker ps --filter name=mi_servicio -q) cat /run/secrets/mi_secreto
```
???
Si commiteamos el container a una imagen, el secreto es desmontado
Si tengo mas replicas el comando debe ser adaptado porque hay mas de un hash, tengo que hacerlo mas a mano
---
## Utilizando secrets con YML&#39;s de docker compose
```yaml
version: &#39;3.1&#39;
services:
    test:
        image: &#39;alpine&#39;
        command: &#39;cat /run/secrets/my_secret&#39;
        secrets: 
            - my_secret
secrets:
    my_secret:
        file: ./mysecret.txt
        # o external: true para tomarlo del swarm
```
???
Gracias al stack del compose
docker stack deploy -c file.yml name
---
## Usando https con secrets
1. Generar certificado con let&#39;s encrypt, self-signed u otra CA
2. Preparar nginx config
3. Preparar secrets en el swarm
```shell
$ docker secret create site.key site.key
$ docker secret create site.crt site.crt
$ docker secret create site.conf site.conf
```
4. Crear el servicio
```shell
$ docker service create --name nginx --secret site.key \
     --secret site.crt --secret site.conf --publish 3000:443 nginx:latest \
     sh -c &#34;ln -s /run/secrets/site.conf /etc/nginx/conf.d/site.conf &amp;&amp; exec nginx -g &#39;daemon off;&#39;&#34;
```
???
Daemon off es un flag de nginx para docker o debug que lo mantiene en foreground y que es amigo de tener un proceso por container
---
## Resumen de comandos
```shell
$ docker swarm init --advertise-addr eth0 # solo para probar local
$ echo &#34;a&#34; | docker secret create mi_secreto -
$ docker secret inspect mi_secreto
$ docker secret ls
$ docker service create --name mi_servicio --secret mi_secreto nginx
$ docker service update mi_servicio --secret-rm mi_secreto
$ docker service update mi_servicio --secret-add mi_nuevo_secreto
$ docker secret rm mi_secreto
```
???
Aca se pueden ver todos los comandos necesarios para por ejemplo hacer una rotacion de logs
---
# Q &amp; A
---
# Gracias!

    </textarea>
  </div>
</div>

<script>
    var slideshow = remark.create();
</script>

    <script>
        var _gaq=[['_setAccount','UA-44929876-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src='//www.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>

</body>
</html>
